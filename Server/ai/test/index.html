<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Emotion Music Test</title>
  <script defer src="https://unpkg.com/face-api.js"></script>
  <style>
    body { font-family: Arial; background: #111; color: #fff; text-align: center; }
    video { border-radius: 10px; margin-top: 10px; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    audio { width: 300px; margin: 10px 0; }
  </style>
</head>
<body>

  <h1>ðŸŽ­ Emotion â†’ Music Recommendation</h1>

  <video id="video" width="300" height="220" autoplay muted></video><br><br>
  <button onclick="detectEmotion()">Detect Emotion</button>

  <h2 id="emotionText"></h2>
  <div id="songs"></div>

<script>
  const video = document.getElementById("video");

  async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
  }

  async function loadModels() {
    const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models";
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
  }

  async function detectEmotion() {
    const detection = await faceapi
      .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
      .withFaceExpressions();

    if (!detection) {
      alert("No face detected");
      return;
    }

    const expressions = detection.expressions;
    const emotion = Object.keys(expressions)
      .reduce((a, b) => expressions[a] > expressions[b] ? a : b);

    document.getElementById("emotionText").innerText =
      "Detected Emotion: " + emotion;

    fetch("http://localhost:5000/recommend", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ emotion })
    })
    .then(res => res.json())
    .then(data => showSongs(data.songs));
  }

  function showSongs(songs) {
    const div = document.getElementById("songs");
    div.innerHTML = "";

    songs.forEach(song => {
      div.innerHTML += `
        <p><b>${song.title}</b> - ${song.artist}</p>
        <audio controls src="${song.url}"></audio>
      `;
    });
  }

  startCamera();
  loadModels();
</script>

</body>
</html>
